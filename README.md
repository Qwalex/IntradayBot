## TraderBot3 — Интрадей-бот для Bybit (TypeScript)

Маленький модульный бот для интрадей-торговли по стратегии пересечения скользящих средних (SMA Cross) на бирже Bybit. Проект написан на TypeScript и запускается через `tsx`. Поддерживает paper-режим по умолчанию и работу с реальными ордерами через REST API Bybit.

### Возможности
- **SMA Cross**: сигналы на основе пересечения SMA(20) и SMA(50) по закрытиям свечей
- **Paper-режим**: безопасная симуляция без реальных ордеров, если нет ключей API или `PAPER=true`
- **Базовый риск-менеджмент**: размер позиции рассчитывается как `ORDER_NOTIONAL / lastPrice`
- **Маршрутизация по алиасам**: импорты через `@config/*`, `@clients/*`, `@utils/*`, `@indicators/*`, `@strategy/*`, `@risk/*`, `@execution/*` (без `@root`)
- **Логирование**: человекочитаемые логи через `pino-pretty`
- **Smoke-скрипт**: быстрая проверка доступа к свечам Bybit

## Архитектура

- `src/index.ts` — точка входа: основной цикл, запрос свечей, вычисление сигнала, исполнение ордеров, интервал 15 секунд
- `src/config/env.ts` — загрузка переменных окружения, валидация и значения по умолчанию
- `src/clients/bybit.ts` — REST-клиент Bybit: публичные свечи, приватные методы (создание ордеров, отмена, позиции, плечо)
- `src/indicators/sma.ts` — индикатор простого скользящего среднего (SMA)
- `src/strategy/smaCross.ts` — генерация сигналов по пересечению SMA(20/50) с защитой от ложных сигналов в ту же сторону
- `src/risk/manager.ts` — функция расчёта размера позиции `computeOrderQty`
- `src/execution/executor.ts` — абстракция исполнения: paper-режим или реальные ордера Market IOC
- `src/utils/logger.ts` — конфигурация логгера `pino`
- `src/tools/smoke.ts` — smoke-проверка получения свечей

## Требования

- Node.js 18+ (ES2022)
- Доступ в интернет к API Bybit

## Установка

1. Установите зависимости:
   ```bash
   npm i
   ```
2. Создайте файл `.env` (см. раздел «Переменные окружения»). Не коммитьте `.env` в репозиторий.

## Переменные окружения

Настраиваются в `.env` (загружается через `dotenv`). Значения по умолчанию указаны в `src/config/env.ts`.

- `BYBIT_API_KEY` — API ключ Bybit (для paper-режима может быть пустым)
- `BYBIT_API_SECRET` — API секрет Bybit (для paper-режима может быть пустым)
- `BYBIT_BASE_URL` — базовый URL Bybit API. По умолчанию: `https://api.bybit.com`
- `SYMBOL` — тикер, например `BTCUSDT`, `ETHUSDT`, `ADAUSDT`
- `TRADING_MODE` — режим торговли Bybit: `linear` | `inverse` | `option` | `spot` (по умолчанию `linear`)
- `TIMEFRAME` — таймфрейм свечей в минутах как строка, например `1`, `3`, `5`, `15`
- `LEVERAGE` — плечо (число). В клиенте есть метод выставления плеча, но по умолчанию не вызывается
- `RISK_PER_TRADE` — доля риска на сделку, сейчас не используется в формуле, зарезервировано для расширения
- `MAX_OPEN_POSITIONS` — максимум открытых позиций (зарезервировано для расширения)
- `PAPER` — `true`/`false`. Если `true` или нет ключей API — ордера не отправляются, всё симулируется
- `LOG_LEVEL` — уровень логирования `pino` (`info` по умолчанию)
- `ORDER_NOTIONAL` — номинал на сделку в валюте котировки, для расчёта количества: `qty = ORDER_NOTIONAL / lastPrice`

Пример `.env` (значения-заглушки):
```env
BYBIT_API_KEY=...
BYBIT_API_SECRET=...
BYBIT_BASE_URL=https://api.bybit.com

SYMBOL=ADAUSDT
TRADING_MODE=linear
TIMEFRAME=1
LEVERAGE=2
RISK_PER_TRADE=0.01
MAX_OPEN_POSITIONS=1
PAPER=true
LOG_LEVEL=info
ORDER_NOTIONAL=50
```

## Скрипты npm

- `npm run smoke` — запросить несколько свечей и вывести их в лог для проверки доступа
- `npm run dev` — запуск бота с авто-перезапуском через `tsx` (из `src/index.ts`)
- `npm start` — то же, что `dev`
- `npm run build` — транспиляция в `dist/`

## Запуск

1. Заполните `.env`
2. Запустите smoke-тест:
   ```bash
   npm run smoke
   ```
3. Запустите бота (paper-режим по умолчанию):
   ```bash
   npm run dev
   ```

Логи содержат ключевые поля: символ, таймфрейм, режим, paper.

## Импорты и алиасы

В проекте используются алиасы из `tsconfig.json`. Важно: **никакого `@root`**. Примеры корректных импортов:

```ts
import { env } from '@config/env';
import { BybitClient } from '@clients/bybit';
import { smaCrossSignal } from '@strategy/smaCross';
import { computeOrderQty } from '@risk/manager';
import { logger } from '@utils/logger';
```

## Логика торговли

- На каждом «тике» запрашиваются последние свечи: `getKlines(symbol, timeframe, 200)`
- Стратегия `smaCrossSignal(closes, 20, 50)` возвращает: `buy` | `sell` | `hold`
- Если сигнал изменился (и не `hold`), бот закрывает все и открывает позицию по рынку в сторону сигнала
- Размер позиции: `qty = ORDER_NOTIONAL / lastPrice` (округляется до 6 знаков)
- Интервал тиков — каждые 15 секунд

Настройка периодов SMA: по умолчанию 20/50. При необходимости отредактируйте вызов в `src/index.ts` или параметризуйте стратегию.

## Исполнение ордеров

- В paper-режиме бот не зовёт приватные методы Bybit, а симулирует открытие/закрытие (`[PAPER]` в логах)
- В боевом режиме создаются рыночные ордера IOC через `/v5/order/create`, перед открытием вызывается `closeAll`
- Метод `setLeverage` есть в клиенте, но не используется по умолчанию — добавьте вызов при необходимости

## Ограничения и заметки

- Нет стоп-лосса/тейк-профита — добавляйте в `Executor` по своему ТЗ
- Считается, что символ и `TRADING_MODE` совместимы (например, `BTCUSDT` для `linear`)
- `TIMEFRAME` — строка по договорённости с Bybit API (в минутах)
- Нет учёта комиссий, скольжения, проскальзываний и частичной ликвидности
- Используется REST, без WebSocket-подписок

## Расширение проекта

- Добавить индикатор: создайте модуль в `src/indicators/*`, экспортируйте функцию и используйте в стратегии
- Добавить стратегию: создайте модуль в `src/strategy/*`, верните `buy`/`sell`/`hold`, подключите в `src/index.ts`
- Изменить риск-менеджмент: скорректируйте `computeOrderQty` (например, учёт баланса через приватный эндпоинт)
- Реальные ордера: выставляйте плечо, добавляйте стоп-ордера, проверяйте позиции через `getPositions`

## Безопасность

- Никогда не публикуйте `.env` и ключи API в репозитории
- Ограничьте ключи правами и IP (в настройках Bybit)
- Для разработки держите `PAPER=true`

## Поиск и диагностика

- «Bybit error: …» — проверьте валидность ключей, права ключа, режим (`TRADING_MODE`) и символ
- Пустые свечи/ошибки сети — проверьте интернет и лимиты API
- `TIMEFRAME` не поддерживается — используйте допустимые значения (например, `1`, `3`, `5`, `15`)

## Лицензия

ISC (см. `package.json`). Используйте на свой страх и риск. Торговля на крипторынке связана с высокими рисками.


